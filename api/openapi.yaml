openapi: 3.0.0
info:
  title: Room Detection API
  description: |
    REST API for uploading blueprints and detecting rooms using YOLOv8 model.
    Processing is asynchronous - upload endpoint returns immediately with a blueprint_id,
    and clients poll the status endpoint to check processing progress.
  version: 1.0.0
  contact:
    name: Room Detection AI Team

servers:
  - url: https://api.roomdetection.ai/api/v1
    description: Production server
  - url: https://{stage}.api.roomdetection.ai/api/v1
    description: Staging server
    variables:
      stage:
        default: dev
        enum:
          - dev
          - staging

paths:
  /blueprints/upload:
    post:
      summary: Upload blueprint and initiate processing
      description: |
        Upload a blueprint image (PNG/JPG) and initiate asynchronous room detection processing.
        Returns immediately with a blueprint_id and status "processing".
        Client should poll the status endpoint to check when processing completes.
      operationId: uploadBlueprint
      tags:
        - Blueprints
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: Blueprint image file (PNG or JPG, max 50MB)
            encoding:
              file:
                contentType: image/png, image/jpeg
      responses:
        '200':
          description: Blueprint uploaded successfully, processing started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          description: Bad request - invalid file format or size
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "invalid_file_format"
                message: "File must be PNG or JPG format"
                details: "Received file type: application/pdf"
        '413':
          description: Payload too large - file exceeds 50MB limit
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "file_too_large"
                message: "File size exceeds 50MB limit"
                details: "File size: 52428800 bytes"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /blueprints/{blueprint_id}/status:
    get:
      summary: Check processing status
      description: |
        Poll this endpoint to check the processing status of an uploaded blueprint.
        Returns status "processing" while work is in progress, "completed" with results
        when done, or "failed" if processing encountered an error.
      operationId: getBlueprintStatus
      tags:
        - Blueprints
      parameters:
        - name: blueprint_id
          in: path
          required: true
          description: Unique identifier for the blueprint
          schema:
            type: string
            pattern: '^bp_[a-zA-Z0-9]+$'
            example: bp_abc123
      responses:
        '200':
          description: Status information
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/StatusResponseProcessing'
                  - $ref: '#/components/schemas/StatusResponseCompleted'
                  - $ref: '#/components/schemas/StatusResponseFailed'
        '404':
          description: Blueprint not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "blueprint_not_found"
                message: "Blueprint with ID bp_abc123 not found"
                blueprint_id: bp_abc123
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /blueprints/{blueprint_id}/results:
    get:
      summary: Retrieve final results
      description: |
        Retrieve the final detected room coordinates for a completed blueprint.
        Alternative to polling the status endpoint - use this to fetch results
        once processing is complete.
      operationId: getBlueprintResults
      tags:
        - Blueprints
      parameters:
        - name: blueprint_id
          in: path
          required: true
          description: Unique identifier for the blueprint
          schema:
            type: string
            pattern: '^bp_[a-zA-Z0-9]+$'
            example: bp_abc123
      responses:
        '200':
          description: Blueprint results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResultsResponse'
        '404':
          description: Blueprint not found or not yet processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    UploadResponse:
      type: object
      required:
        - blueprint_id
        - status
        - message
      properties:
        blueprint_id:
          type: string
          pattern: '^bp_[a-zA-Z0-9]+$'
          description: Unique identifier for the uploaded blueprint
          example: bp_abc123
        status:
          type: string
          enum: [processing]
          description: Initial status is always "processing"
          example: processing
        message:
          type: string
          description: Human-readable status message
          example: "Blueprint uploaded successfully. Processing started."

    StatusResponseProcessing:
      type: object
      required:
        - blueprint_id
        - status
        - message
      properties:
        blueprint_id:
          type: string
          pattern: '^bp_[a-zA-Z0-9]+$'
          example: bp_abc123
        status:
          type: string
          enum: [processing]
          example: processing
        message:
          type: string
          example: "Analyzing blueprint..."

    StatusResponseCompleted:
      type: object
      required:
        - blueprint_id
        - status
        - processing_time_ms
        - detected_rooms
      properties:
        blueprint_id:
          type: string
          pattern: '^bp_[a-zA-Z0-9]+$'
          example: bp_abc123
        status:
          type: string
          enum: [completed]
          example: completed
        processing_time_ms:
          type: integer
          description: Processing time in milliseconds
          example: 15420
        detected_rooms:
          type: array
          items:
            $ref: '#/components/schemas/DetectedRoom'
          description: List of detected rooms with bounding boxes

    StatusResponseFailed:
      type: object
      required:
        - blueprint_id
        - status
        - error
        - message
      properties:
        blueprint_id:
          type: string
          pattern: '^bp_[a-zA-Z0-9]+$'
          example: bp_abc123
        status:
          type: string
          enum: [failed]
          example: failed
        error:
          type: string
          description: Error code
          example: processing_failed
        message:
          type: string
          description: Human-readable error message
          example: "Unable to detect clear room boundaries"

    ResultsResponse:
      type: object
      required:
        - blueprint_id
        - detected_rooms
        - total_rooms
      properties:
        blueprint_id:
          type: string
          pattern: '^bp_[a-zA-Z0-9]+$'
          example: bp_abc123
        original_url:
          type: string
          format: uri
          description: S3 URL to the original blueprint image
          example: "https://s3.amazonaws.com/bucket/blueprints/bp_abc123.png"
        detected_rooms:
          type: array
          items:
            $ref: '#/components/schemas/DetectedRoom'
        total_rooms:
          type: integer
          description: Total number of detected rooms
          example: 15

    DetectedRoom:
      type: object
      required:
        - id
        - bounding_box
        - confidence
      properties:
        id:
          type: string
          description: Unique identifier for the room
          example: room_001
        bounding_box:
          type: array
          items:
            type: integer
          minItems: 4
          maxItems: 4
          description: |
            Bounding box coordinates in normalized 0-1000 range.
            Format: [x_min, y_min, x_max, y_max]
          example: [50, 50, 200, 300]
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: Detection confidence score (0.0 to 1.0)
          example: 0.95

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: processing_failed
        message:
          type: string
          description: Human-readable error message
          example: "Unable to detect clear room boundaries"
        blueprint_id:
          type: string
          pattern: '^bp_[a-zA-Z0-9]+$'
          description: Blueprint ID (if applicable)
          example: bp_abc123
        details:
          type: string
          description: Additional error details
          example: "No enclosed spaces found in blueprint"

